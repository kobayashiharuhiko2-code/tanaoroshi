<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>清和産業 スマート棚卸 v30</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #1e293b; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #475569; border-radius: 3px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #64748b; }
        .no-select { -webkit-touch-callout: none; -webkit-user-select: none; user-select: none; -webkit-tap-highlight-color: transparent; }
        body { overscroll-behavior-y: none; }
        @keyframes popIn { 0% { transform: scale(0.9); opacity: 0; } 100% { transform: scale(1); opacity: 1; } }
        .animate-pop { animation: popIn 0.2s ease-out forwards; }
    </style>
</head>
<body class="bg-slate-900 text-slate-100">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // --- アイコン ---
        const IconBase = ({ children, className, ...props }) => (<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className} {...props}>{children}</svg>);
        const Calculator = (p) => <IconBase {...p}><rect width="16" height="20" x="4" y="2" rx="2"/><line x1="8" x2="16" y1="6" y2="6"/><line x1="16" x2="16" y1="14" y2="18"/><path d="M16 10h.01"/><path d="M12 10h.01"/><path d="M8 10h.01"/><path d="M12 14h.01"/><path d="M8 14h.01"/><path d="M12 18h.01"/><path d="M8 18h.01"/></IconBase>;
        const Mic = (p) => <IconBase {...p}><path d="M12 2a3 3 0 0 0-3 3v7a3 3 0 0 0 6 0V5a3 3 0 0 0-3-3Z"/><path d="M19 10v2a7 7 0 0 1-14 0v-2"/><line x1="12" x2="12" y1="19" y2="22"/></IconBase>;
        const Save = (p) => <IconBase {...p}><path d="M15.2 3a2 2 0 0 1 1.4.6l3.8 3.8a2 2 0 0 1 .6 1.4V19a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2z"/><path d="M17 21v-8H7v8"/><path d="M7 3v5h8"/></IconBase>;
        const Trash2 = (p) => <IconBase {...p}><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></IconBase>;
        const History = (p) => <IconBase {...p}><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 12"/><path d="M3 3v9h9"/><path d="M12 7v5l4 2"/></IconBase>;
        const RotateCcw = (p) => <IconBase {...p}><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 12"/><path d="M3 3v9h9"/></IconBase>; 
        const RotateCw = (p) => <IconBase {...p}><path d="M21 12a9 9 0 1 1-9-9 9.75 9.75 0 0 1 6.74 2.74L21 12"/><path d="M21 3v9h-9"/></IconBase>; 
        const MapPin = (p) => <IconBase {...p}><path d="M20 10c0 6-8 12-8 12s-8-6-8-12a8 8 0 0 1 16 0Z"/><circle cx="12" cy="10" r="3"/></IconBase>;
        const ChevronDown = (p) => <IconBase {...p}><path d="m6 9 6 6 6-6"/></IconBase>;
        const AlertTriangle = (p) => <IconBase {...p}><path d="m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z"/><path d="M12 9v4"/><path d="M12 17h.01"/></IconBase>;
        const CheckCircle = (p) => <IconBase {...p}><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><path d="m9 11 3 3L22 4"/></IconBase>;
        const Upload = (p) => <IconBase {...p}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" x2="12" y1="3" y2="15"/></IconBase>;
        const Database = (p) => <IconBase {...p}><ellipse cx="12" cy="5" rx="9" ry="3"/><path d="M3 5V19A9 3 0 0 0 21 19V5"/><path d="M3 12A9 3 0 0 0 21 12"/></IconBase>;
        const Cloud = (p) => <IconBase {...p}><path d="M17.5 19c0-3.037-2.463-5.5-5.5-5.5S6.5 15.963 6.5 19"/><path d="M17.5 19H9"/><path d="M17.5 15.5a3.5 3.5 0 1 1-7 0"/><path d="M5.5 19a1.5 1.5 0 1 1 0-3"/><path d="M13 13.5v-3a6 6 0 0 0-12 0v1.65"/></IconBase>;
        const Layers = (p) => <IconBase {...p}><polygon points="12 2 2 7 12 12 22 7 12 2" /><polyline points="2 17 12 22 22 17" /><polyline points="2 12 12 17 22 12" /></IconBase>;
        const Box = (p) => <IconBase {...p}><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/><polyline points="3.27 6.96 12 12.01 20.73 6.96"/><line x1="12" x2="12" y1="22.08" y2="12"/></IconBase>;
        const X = (p) => <IconBase {...p}><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></IconBase>;
        const Delete = (p) => <IconBase {...p}><path d="M21 4H8l-7 8 7 8h13a2 2 0 0 0 2-2V6a2 2 0 0 0-2-2z"/><line x1="18" y1="9" x2="12" y2="15"/><line x1="12" y1="9" x2="18" y2="15"/></IconBase>;

        // Sound Class
        class SoundEffect {
            constructor() { this.ctx = null; }
            init() { if (!this.ctx) { try { const AudioContext = window.AudioContext || window.webkitAudioContext; if (AudioContext) this.ctx = new AudioContext(); } catch(e) { console.error(e); } } }
            playTone(type, freq, dur) { try { this.init(); if (!this.ctx) return; if(this.ctx.state === 'suspended') this.ctx.resume().catch(e=>{}); const osc = this.ctx.createOscillator(); const gain = this.ctx.createGain(); osc.connect(gain); gain.connect(this.ctx.destination); osc.type = type; osc.frequency.setValueAtTime(freq, this.ctx.currentTime); gain.gain.setValueAtTime(0.1, this.ctx.currentTime); gain.gain.exponentialRampToValueAtTime(0.01, this.ctx.currentTime + dur); osc.start(); osc.stop(this.ctx.currentTime + dur); } catch(e) {} }
            playOk() { this.playTone('sine', 880, 0.3); }
            playStep() { this.playTone('sine', 600, 0.15); }
            playNg() { try { this.init(); if(!this.ctx) return; if(this.ctx.state === 'suspended') this.ctx.resume().catch(e=>{}); const osc = this.ctx.createOscillator(); const gain = this.ctx.createGain(); osc.connect(gain); gain.connect(this.ctx.destination); osc.type = 'square'; osc.frequency.setValueAtTime(100, this.ctx.currentTime); osc.frequency.linearRampToValueAtTime(80, this.ctx.currentTime + 0.2); gain.gain.setValueAtTime(0.15, this.ctx.currentTime); gain.gain.linearRampToValueAtTime(0.01, this.ctx.currentTime + 0.2); osc.start(); osc.stop(this.ctx.currentTime + 0.2); } catch(e) {} }
        }
        const soundEffect = new SoundEffect();

        function App() {
            const [activeTab, setActiveTab] = useState('input');
            const [items, setItems] = useState([]);
            const [history, setHistory] = useState([]);
            const [future, setFuture] = useState([]);
            const [masterData, setMasterData] = useState({'RV8': { unitCount: 20, aliases: [] }, 'R7H': { unitCount: 16, aliases: [] }, 'TP3': { unitCount: 10, aliases: [] }});
            const [areaList, setAreaList] = useState(['エリア1', 'エリア2']);
            const [currentArea, setCurrentArea] = useState('エリア1'); 
            const [isListening, setIsListening] = useState(false);
            const [transcript, setTranscript] = useState('');
            const [feedbackMessage, setFeedbackMessage] = useState('');
            const [feedbackType, setFeedbackType] = useState('info');
            const [manualMode, setManualMode] = useState(false);
            const [isLoaded, setIsLoaded] = useState(false);
            const [showAreaSelect, setShowAreaSelect] = useState(false);
            const [unsavedChanges, setUnsavedChanges] = useState(false);
            const [defaultUnit, setDefaultUnit] = useState('pile'); 
            const [inputStep, setInputStep] = useState('code'); 
            const [pendingCode, setPendingCode] = useState(null); 
            const [debugText, setDebugText] = useState('');
            
            const transcriptRef = useRef('');
            const recognitionRef = useRef(null);
            const [manualQty, setManualQty] = useState('');

            useEffect(() => {
                const loadData = () => {
                    try {
                        const savedMaster = localStorage.getItem('inventory_masterData_v30'); // v30
                        const savedAreaList = localStorage.getItem('inventory_areaList_v30');
                        const savedItems = localStorage.getItem('inventory_items_v30');
                        if (savedMaster) setMasterData(JSON.parse(savedMaster));
                        if (savedAreaList) {
                            const parsed = JSON.parse(savedAreaList);
                            setAreaList(parsed);
                            if(parsed.length > 0) setCurrentArea(parsed[0]);
                        }
                        if (savedItems) setItems(JSON.parse(savedItems));
                    } catch (e) { console.error(e); } finally { setIsLoaded(true); }
                };
                loadData();
            }, []);

            useEffect(() => { if (isLoaded) localStorage.setItem('inventory_masterData_v30', JSON.stringify(masterData)); }, [masterData, isLoaded]);
            useEffect(() => { if (isLoaded) localStorage.setItem('inventory_areaList_v30', JSON.stringify(areaList)); }, [areaList, isLoaded]);
            useEffect(() => { if (isLoaded) localStorage.setItem('inventory_items_v30', JSON.stringify(items)); }, [items, isLoaded]);

            useEffect(() => {
                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                if (SpeechRecognition) {
                    recognitionRef.current = new SpeechRecognition();
                    recognitionRef.current.continuous = true;
                    recognitionRef.current.interimResults = true;
                    recognitionRef.current.lang = 'ja-JP';
                    recognitionRef.current.onresult = (event) => {
                        let final = ''; let interim = '';
                        for (let i = event.resultIndex; i < event.results.length; ++i) {
                            if (event.results[i].isFinal) final += event.results[i][0].transcript;
                            else interim += event.results[i][0].transcript;
                        }
                        const resultText = final || interim;
                        setTranscript(resultText);
                        transcriptRef.current = resultText;
                    };
                    recognitionRef.current.onerror = (e) => { console.error(e); setIsListening(false); };
                }
            }, []);

            const startListening = () => { 
                if (recognitionRef.current && !isListening) { 
                    setTranscript(''); 
                    transcriptRef.current = ''; 
                    setFeedbackMessage(''); 
                    recognitionRef.current.start(); 
                    setIsListening(true); 
                } 
            };
            
            const stopListening = () => { 
                if (recognitionRef.current && isListening) { 
                    recognitionRef.current.stop(); 
                    setIsListening(false); 
                    setTimeout(() => {
                        const finalText = transcriptRef.current;
                        if (inputStep === 'code') parseCodeInput(finalText);
                        else parseQtyInput(finalText);
                    }, 200); 
                } 
            };
            const getCurrentSeq = () => items.filter(i => i.area === currentArea).length + 1;

            const purify = (str) => {
                if (!str) return "";
                let s = str.replace(/[Ａ-Ｚａ-ｚ０-９]/g, function(s) {
                    return String.fromCharCode(s.charCodeAt(0) - 0xFEE0);
                });
                s = s.toUpperCase();
                return s.replace(/[^A-Z0-9]/g, '');
            };

            const normalizeNumbers = (text) => {
                let s = text;
                const map = {
                    '一':1, '二':2, '三':3, '四':4, '五':5, '六':6, '七':7, '八':8, '九':9, '十':10,
                    'イチ':1, 'ニ':2, 'サン':3, 'ヨン':4, 'シ':4, 'ゴ':5, 'ロク':6, 'ナナ':7, 'シチ':7, 'ハチ':8, 'キュウ':9, 'ク':9, 'ジュウ':10,
                    'ゼロ':0, '零':0, 'マル':0,
                    'テン':'.', 'ドット':'.', 'コンマ':'.', 'ポチ':'.', '．':'.',
                    'ブイ':'V', 'アール':'R', 'エイチ':'H', 'ティー':'T', 'ピー':'P', 'エム':'M', 'エル':'L', 'ケー':'K', 
                    'ワイ':'Y', 'ダブリュー':'W', 'ゼット':'Z', 'ジェイ':'J', 'ユー':'U', 'エフ':'F', 'オー':'O', 'キュー':'Q',
                    'エス':'S', 'ジー':'G', 'ビー':'B', 'シー':'C', 'ディー':'D', 'イー':'E', 'エックス':'X', 'アイ':'I', 'エヌ':'N', 'エー':'A'
                };
                Object.keys(map).forEach(k => {
                    s = s.replace(new RegExp(k, 'g'), map[k]);
                });
                return s;
            };

            const parseCodeInput = (text) => {
                if (!text || text.trim() === '') return;
                
                const normalizedText = normalizeNumbers(text);
                const target = purify(normalizedText); 
                
                setDebugText(`認識: "${text}" -> 変: "${normalizedText}"`);

                if (!target && !text.match(/[ァ-ンー]/)) { 
                    setFeedbackType('error');
                    setFeedbackMessage(`認識失敗: "${text}"`);
                    soundEffect.playNg();
                    setTranscript('');
                    return;
                }

                let detectedCode = 'Unknown';
                const masterKeys = Object.keys(masterData).filter(k => k && k.trim().length > 0);

                for (const key of masterKeys) {
                    const pKey = purify(key);
                    if (pKey === target) { detectedCode = key; break; }
                }

                if (detectedCode === 'Unknown') {
                    for (const key of masterKeys) {
                        const pKey = purify(key);
                        if (pKey.startsWith('R') && pKey.substring(1) === target) {
                            detectedCode = key; break;
                        }
                    }
                }

                if (detectedCode === 'Unknown') {
                    for (const key of masterKeys) {
                        const aliases = masterData[key].aliases || [];
                        for (const alias of aliases) {
                            const normAlias = normalizeNumbers(alias);
                            if (text.includes(alias) || normalizedText.includes(normAlias)) {
                                detectedCode = key; break;
                            }
                            const pAlias = purify(normAlias);
                            if (pAlias.length > 0 && pAlias === target) {
                                detectedCode = key; break;
                            }
                        }
                        if (detectedCode !== 'Unknown') break;
                    }
                }

                if (detectedCode === 'Unknown' && target.length >= 2) {
                    for (const key of masterKeys) {
                        const pKey = purify(key);
                        if (pKey.includes(target) || target.includes(pKey)) { detectedCode = key; break; }
                        if (pKey.startsWith('R')) {
                            const pKeyNoR = pKey.substring(1);
                            if (pKeyNoR.length > 0 && (pKeyNoR.includes(target) || target.includes(pKeyNoR))) {
                                detectedCode = key; break;
                            }
                        }
                    }
                }

                if (detectedCode !== 'Unknown') {
                    setPendingCode(detectedCode);
                    setInputStep('qty');
                    setFeedbackType('info');
                    setFeedbackMessage(`コード確定: ${detectedCode}`);
                    soundEffect.playStep();
                } else {
                    setFeedbackType('error');
                    setFeedbackMessage(`登録なし: "${text}"`);
                    soundEffect.playNg();
                }
                setTranscript('');
            };

            const parseQtyInput = (text) => {
                if (!text || text.trim() === '') return;
                setDebugText(`Qty認識: "${text}"`);
                
                const normalizedText = normalizeNumbers(text);
                const matches = normalizedText.match(/[\d\.]+/g);
                
                let inputQuantity = 0;
                if (matches && matches.length > 0) {
                    inputQuantity = parseFloat(matches[matches.length - 1]);
                }

                if (inputQuantity > 0) {
                    registerItem(inputQuantity, text);
                } else {
                    setFeedbackType('error');
                    setFeedbackMessage(`数量不明: "${text}"`);
                    soundEffect.playNg();
                }
                setTranscript('');
            };

            const registerItem = (qty, sourceText = "") => {
                let isPileCount = (defaultUnit === 'pile');
                if (sourceText) {
                    const pileKeywords = ['山', 'ヤマ', '段', 'ダン', 'セット', '箱', 'ケース', '入'];
                    const pieceKeywords = ['個', 'コ', '本', '枚', 'バラ'];
                    if (pileKeywords.some(w => sourceText.includes(w))) isPileCount = true;
                    else if (pieceKeywords.some(w => sourceText.includes(w))) isPileCount = false;
                }

                let totalCount = qty;
                let unitSize = 1;
                if (masterData[pendingCode]) {
                    unitSize = masterData[pendingCode].unitCount;
                    if (isPileCount) totalCount = Math.round(qty * unitSize * 100) / 100;
                }

                addItem(pendingCode, qty, totalCount, isPileCount, unitSize);
                setFeedbackType('success');
                setFeedbackMessage(`No.${getCurrentSeq()}: ${pendingCode} ${qty}${isPileCount ? `山(×${unitSize})` : '個'} 登録`);
                soundEffect.playOk();
                
                resetStep();
            };

            const resetStep = () => { setPendingCode(null); setInputStep('code'); setFeedbackMessage(''); setTranscript(''); setManualQty(''); };
            const handleManualSelect = (code) => { soundEffect.playStep(); setPendingCode(code); setInputStep('qty'); setFeedbackMessage(`コード選択: ${code}`); setTranscript(''); };

            const handleTenkeyInput = (num) => {
                setManualQty(prev => {
                    if (num === '.' && prev.includes('.')) return prev;
                    const val = prev + num.toString();
                    if (val.length > 6) return prev; 
                    return val;
                });
            };
            const handleTenkeyDelete = () => setManualQty(prev => prev.slice(0, -1));
            const handleTenkeyEnter = () => {
                const qty = parseFloat(manualQty);
                if (qty > 0) registerItem(qty);
            };

            const addItem = (code, inputQty, total, isPile, unitSize) => {
                const newItem = {
                    id: Date.now(),
                    area: currentArea,
                    seq: getCurrentSeq(),
                    code: code,
                    inputQty: inputQty,
                    isPile: isPile,
                    unitSize: unitSize,
                    total: total,
                    timestamp: new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', second: '2-digit' })
                };
                setItems(prev => [newItem, ...prev]);
                setHistory(prev => [...prev, { type: 'add', item: newItem, index: 0 }]);
                setFuture([]); 
                setUnsavedChanges(true);
            };

            const removeItem = (id) => {
                const index = items.findIndex(i => i.id === id);
                if (index === -1) return;
                const target = items[index];
                const newItems = [...items];
                newItems.splice(index, 1);
                setItems(newItems);
                setHistory(prev => [...prev, { type: 'delete', item: target, index: index }]);
                setFuture([]);
                setUnsavedChanges(true);
            };
            
            const undoLastAction = () => {
                if (history.length === 0) return;
                const lastAction = history[history.length - 1];
                const newHistory = history.slice(0, -1);
                setHistory(newHistory);
                if (lastAction.type === 'add') {
                    setItems(prev => prev.filter(i => i.id !== lastAction.item.id));
                    setFuture(prev => [...prev, lastAction]);
                } else if (lastAction.type === 'delete') {
                    setItems(prev => {
                        const restored = [...prev];
                        const insertIndex = Math.min(lastAction.index, restored.length);
                        restored.splice(insertIndex, 0, lastAction.item);
                        return restored;
                    });
                    setFuture(prev => [...prev, lastAction]);
                }
                setUnsavedChanges(true);
            };

            const redoLastAction = () => {
                if (future.length === 0) return;
                const nextAction = future[future.length - 1];
                const newFuture = future.slice(0, -1);
                setFuture(newFuture);
                if (nextAction.type === 'add') {
                    setItems(prev => {
                        const restored = [...prev];
                        const insertIndex = Math.min(nextAction.index, restored.length);
                        restored.splice(insertIndex, 0, nextAction.item);
                        return restored;
                    });
                    setHistory(prev => [...prev, nextAction]);
                } else if (nextAction.type === 'delete') {
                    setItems(prev => prev.filter(i => i.id !== nextAction.item.id));
                    setHistory(prev => [...prev, nextAction]);
                }
                setUnsavedChanges(true);
            };

            const clearAllData = () => { if (window.confirm("全消去しますか？")) { setItems([]); setHistory([]); setFuture([]); setUnsavedChanges(false); } };
            
            const downloadCSV = (content, filename) => {
                const blob = new Blob([new Uint8Array([0xEF, 0xBB, 0xBF]), content], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                if (link.download !== undefined) {
                    const url = URL.createObjectURL(blob); link.setAttribute('href', url); link.setAttribute('download', filename);
                    document.body.appendChild(link); link.click(); document.body.removeChild(link);
                }
            };

            const exportCurrentAreaCSV = () => {
                const targetItems = items.filter(i => i.area === currentArea);
                if (targetItems.length === 0) { alert("データなし"); return; }
                const header = "エリア名,行No,コード,入力数,単位フラグ,1単位数,合計数量,時刻\n";
                const rows = targetItems.sort((a,b)=>a.seq-b.seq).map(item => `${item.area},${item.seq},${item.code},${item.inputQty},${item.isPile?'1':'0'},${item.unitSize},${item.total},${item.timestamp}`).join("\n");
                const now = new Date();
                const d = `${now.getFullYear()}${(now.getMonth()+1).toString().padStart(2,'0')}${now.getDate().toString().padStart(2,'0')}_${now.getHours().toString().padStart(2,'0')}${now.getMinutes().toString().padStart(2,'0')}`;
                downloadCSV(header + rows, `${currentArea}_${d}.csv`);
                setUnsavedChanges(false);
            };

            const handleAreaUpload = (e) => {
                const f = e.target.files[0]; if(!f)return;
                const r = new FileReader(); r.onload=(ev)=>{
                    const lines = ev.target.result.split(/\r\n|\n/); const arr=[];
                    lines.forEach(l=>{
                        const cleanLine = l.replace(/[\x00-\x1F\x7F]/g, "").trim();
                        if (!cleanLine) return;
                        const p = cleanLine.split(',');
                        let n = (p.length >= 2 && p[1].trim()) ? p[1].trim() : p[0].trim();
                        if(n && n.length > 0 && !cleanLine.includes('番号') && !cleanLine.includes('保管場所') && !arr.includes(n)) {
                            arr.push(n);
                        }
                    });
                    if(arr.length){ setAreaList(arr); setCurrentArea(arr[0]); alert(`エリア更新: ${arr.length}件`); }
                };
                r.readAsText(f, 'Shift_JIS');
            };

            const handleMasterUpload = (e) => {
                const f = e.target.files[0]; if(!f)return;
                const r = new FileReader(); r.onload=(ev)=>{
                    const lines = ev.target.result.split(/\r\n|\n/); const m={};
                    let emptyCount = 0;
                    lines.forEach(l=>{
                        const cleanLine = l.replace(/[\x00-\x1F\x7F]/g, "").trim();
                        if (!cleanLine) return;
                        const p = cleanLine.split(',');
                        if(p.length>=1){ 
                            const c = p[0].trim();
                            if (!c || c.length === 0) return;
                            let q=parseInt(p[1]);
                            if(isNaN(q)) { q = 1; emptyCount++; } 
                            const aliases = [];
                            for (let i = 2; i < p.length; i++) {
                                if (p[i] && p[i].trim()) aliases.push(p[i].trim());
                            }
                            if(c && !cleanLine.includes('容器名') && !cleanLine.includes('段数')) {
                                m[c] = { unitCount: q, aliases: aliases };
                            }
                        }
                    });
                    setMasterData(m);
                    alert(`マスタ更新完了 (全${Object.keys(m).length}件)\n※別名(C列以降)も読み込みました`);
                };
                r.readAsText(f, 'Shift_JIS');
            };

            const currentContextItems = items.filter(i => i.area === currentArea);

            if (!isLoaded) return <div className="p-4 text-white text-center">Load...</div>;

            return (
                <div className="pb-24 max-w-md mx-auto min-h-screen bg-slate-900">
                    <div className="bg-slate-800 p-2 shadow-md sticky top-0 z-20 border-b border-slate-700 flex justify-between items-center">
                        <h1 className="text-sm font-bold flex items-center gap-1 text-blue-400"><Calculator className="w-4 h-4"/> v30 (ハイブリッド入力)</h1>
                        <div className="bg-slate-700 rounded flex">
                            <button onClick={()=>setActiveTab('input')} className={`px-3 py-1 text-xs rounded ${activeTab==='input'?'bg-blue-600 text-white':'text-slate-400'}`}>入力</button>
                            <button onClick={()=>setActiveTab('settings')} className={`px-3 py-1 text-xs rounded ${activeTab==='settings'?'bg-blue-600 text-white':'text-slate-400'}`}>設定</button>
                        </div>
                    </div>

                    <div className="px-2 pt-2 relative">
                        <button onClick={()=>setShowAreaSelect(!showAreaSelect)} className="w-full bg-slate-800 p-2 rounded border border-slate-600 flex justify-between items-center">
                             <div className="flex items-center gap-2"><MapPin className="w-4 h-4 text-green-400"/><span className="font-bold text-white">{currentArea}</span></div>
                             <ChevronDown className="w-4 h-4 text-slate-400"/>
                        </button>
                        {showAreaSelect && (
                            <div className="absolute top-12 left-2 right-2 bg-slate-800 border border-slate-600 rounded shadow-xl z-50 max-h-64 overflow-y-auto">
                                {areaList.map(a=><button key={a} onClick={()=>{setCurrentArea(a);setShowAreaSelect(false);}} className="w-full text-left p-3 border-b border-slate-700 text-slate-200">{a}</button>)}
                            </div>
                        )}
                    </div>

                    <div className="p-4 space-y-4">
                        {activeTab === 'input' && (
                            <>
                                {/* Step Indicator */}
                                <div className="flex items-center justify-center gap-4 text-sm font-bold">
                                    <div className={`px-3 py-1 rounded-full ${inputStep==='code' ? 'bg-blue-600 text-white animate-pulse' : 'bg-slate-700 text-slate-500'}`}>1.コード</div>
                                    <div className="text-slate-600">▶</div>
                                    <div className={`px-3 py-1 rounded-full ${inputStep==='qty' ? 'bg-green-600 text-white animate-pulse' : 'bg-slate-700 text-slate-500'}`}>2.数量</div>
                                </div>

                                <div className="bg-slate-800 p-1 rounded-lg flex items-center justify-between border border-slate-600">
                                    <button onClick={() => setDefaultUnit('pile')} className={`flex-1 py-2 rounded-md flex items-center justify-center gap-2 transition-all ${defaultUnit === 'pile' ? 'bg-blue-600 text-white font-bold shadow-lg' : 'text-slate-400 hover:bg-slate-700'}`}>
                                        <Layers className="w-4 h-4" /><span>箱/山</span>
                                    </button>
                                    <button onClick={() => setDefaultUnit('piece')} className={`flex-1 py-2 rounded-md flex items-center justify-center gap-2 transition-all ${defaultUnit === 'piece' ? 'bg-purple-600 text-white font-bold shadow-lg' : 'text-slate-400 hover:bg-slate-700'}`}>
                                        <Box className="w-4 h-4" /><span>個/バラ</span>
                                    </button>
                                </div>

                                <div className={`px-3 py-2 rounded border flex justify-between items-center ${unsavedChanges?'bg-yellow-900/20 border-yellow-600':'bg-green-900/20 border-green-600'}`}>
                                    <div className="flex items-center gap-2 text-xs">
                                        {unsavedChanges?<AlertTriangle className="w-4 h-4 text-yellow-500"/>:<CheckCircle className="w-4 h-4 text-green-500"/>}
                                        <span className={unsavedChanges?'text-yellow-400':'text-green-400'}>{unsavedChanges?'未保存':'保存済'} ({currentContextItems.length}件)</span>
                                    </div>
                                    <button onClick={exportCurrentAreaCSV} className="bg-slate-700 px-3 py-1 rounded text-xs flex items-center gap-1 hover:bg-slate-600"><Save className="w-3 h-3"/>保存</button>
                                </div>

                                {/* Mic Area & Manual Input */}
                                <div className={`bg-gradient-to-b p-6 rounded-2xl shadow-inner border text-center relative transition-colors duration-300 ${inputStep==='code' ? 'from-slate-800 to-slate-900 border-blue-500/50' : 'from-slate-800 to-green-900/20 border-green-500/50'}`}>
                                    
                                    {inputStep === 'qty' && (
                                        <div className="absolute top-2 left-2 right-2">
                                            <div className="bg-slate-900/80 p-2 rounded border border-blue-500 text-blue-300 font-mono text-xl font-bold animate-pop">
                                                {pendingCode} <span className="text-xs text-slate-400">を選択中</span>
                                            </div>
                                        </div>
                                    )}

                                    <div className="h-16 flex items-center justify-center mb-2 mt-6">
                                        {transcript ? 
                                            <p className="text-xl font-bold text-white animate-pulse">{transcript}</p> : 
                                            <div className="flex flex-col items-center">
                                                <p className={`text-lg font-bold drop-shadow-md ${inputStep==='code'?'text-blue-400':'text-green-400'}`}>
                                                    {inputStep === 'code' ? "「コード」を話す" : "「数量」を話す"}
                                                </p>
                                                {feedbackMessage && <p className={`text-xs mt-1 ${feedbackType==='error'?'text-red-400':feedbackType==='success'?'text-green-400':'text-slate-400'}`}>{feedbackMessage}</p>}
                                                {debugText && <p className="text-[10px] text-slate-600 mt-1 font-mono">{debugText}</p>}
                                            </div>
                                        }
                                    </div>

                                    {!manualMode ? (
                                        <div className="relative">
                                            <button 
                                                onMouseDown={startListening} onMouseUp={stopListening}
                                                onTouchStart={startListening} onTouchEnd={stopListening} onMouseLeave={stopListening}
                                                className={`w-24 h-24 rounded-full flex items-center justify-center mx-auto transition-all shadow-xl no-select ${
                                                    isListening 
                                                    ? 'bg-red-500 scale-105 ring-4 ring-red-500/30' 
                                                    : inputStep === 'code'
                                                        ? 'bg-blue-600 ring-4 ring-blue-600/20 active:scale-95'
                                                        : 'bg-green-600 ring-4 ring-green-600/20 active:scale-95'
                                                }`}
                                            >
                                                <Mic className="w-10 h-10 text-white"/>
                                            </button>
                                            
                                            {/* Undo / Redo */}
                                            {inputStep === 'code' && (
                                                <>
                                                    <button onClick={undoLastAction} disabled={history.length===0} className="absolute right-4 bottom-0 bg-slate-700 p-3 rounded-full disabled:opacity-30 hover:bg-slate-600 transition shadow-lg border border-slate-600" title="ひとつ戻る(Undo)">
                                                        <RotateCcw className="w-5 h-5 text-slate-300"/>
                                                    </button>
                                                    <button onClick={redoLastAction} disabled={future.length===0} className="absolute left-4 bottom-0 bg-slate-700 p-3 rounded-full disabled:opacity-30 hover:bg-slate-600 transition shadow-lg border border-slate-600" title="やり直す(Redo)">
                                                        <RotateCw className="w-5 h-5 text-slate-300"/>
                                                    </button>
                                                </>
                                            )}

                                            {/* 数量入力時のハイブリッドUI（テンキー表示） */}
                                            {inputStep === 'qty' && (
                                                <div className="absolute inset-0 bg-slate-900/90 z-10 flex flex-col justify-end p-2 rounded-2xl">
                                                    <div className="flex justify-between items-center mb-2 px-2">
                                                        <span className="text-xs text-slate-400">音声またはテンキーで入力</span>
                                                        <button onClick={resetStep} className="bg-red-900/50 text-red-200 px-3 py-1 rounded text-xs border border-red-500">キャンセル</button>
                                                    </div>
                                                    <div className="bg-black/50 p-2 rounded mb-2 text-right text-2xl font-mono text-white h-12 flex items-center justify-end border border-green-500/50">
                                                        {manualQty || transcript || "0"}
                                                    </div>
                                                    <div className="grid grid-cols-3 gap-2">
                                                        {[7,8,9,4,5,6,1,2,3].map(n=>(
                                                            <button key={n} onClick={()=>handleTenkeyInput(n)} className="bg-slate-700 p-3 rounded text-xl font-bold hover:bg-slate-600 active:bg-slate-500">{n}</button>
                                                        ))}
                                                        <button onClick={handleTenkeyDelete} className="bg-slate-700 p-3 rounded flex items-center justify-center hover:bg-slate-600"><Delete className="w-6 h-6"/></button>
                                                        <button onClick={()=>handleTenkeyInput(0)} className="bg-slate-700 p-3 rounded text-xl font-bold hover:bg-slate-600">0</button>
                                                        <button onClick={()=>handleTenkeyInput('.')} className="bg-slate-700 p-3 rounded text-xl font-bold hover:bg-slate-600">.</button>
                                                    </div>
                                                    <div className="flex gap-2 mt-2">
                                                        {/* 音声ボタンも残す */}
                                                        <button 
                                                            onMouseDown={startListening} onMouseUp={stopListening}
                                                            onTouchStart={startListening} onTouchEnd={stopListening}
                                                            className={`flex-1 p-3 rounded font-bold flex items-center justify-center gap-2 ${isListening ? 'bg-red-500' : 'bg-blue-600'}`}
                                                        >
                                                            <Mic className="w-5 h-5"/> {isListening ? '認識中' : '声で入力'}
                                                        </button>
                                                        <button onClick={handleTenkeyEnter} className="flex-1 bg-green-600 text-white p-3 rounded font-bold hover:bg-green-500 active:bg-green-400">確定</button>
                                                    </div>
                                                </div>
                                            )}
                                        </div>
                                    ) : (
                                        // 完全手動モードUI
                                        <div>
                                            {inputStep === 'code' ? (
                                                <div className="grid grid-cols-2 gap-2 h-48 overflow-y-auto custom-scrollbar">
                                                    {Object.keys(masterData).map(c=><button key={c} onClick={() => handleManualSelect(c)} className="p-3 rounded text-sm font-mono bg-slate-700 active:bg-blue-600 text-white border border-slate-600">{c}</button>)}
                                                </div>
                                            ) : (
                                                // 数量入力テンキー (小数対応)
                                                <div className="bg-slate-800 p-2 rounded-lg">
                                                    <div className="bg-black/50 p-2 rounded mb-2 text-right text-2xl font-mono text-white h-12 flex items-center justify-end">
                                                        {manualQty || "0"}
                                                    </div>
                                                    <div className="grid grid-cols-3 gap-2">
                                                        {[7,8,9,4,5,6,1,2,3].map(n=>(
                                                            <button key={n} onClick={()=>handleTenkeyInput(n)} className="bg-slate-700 p-3 rounded text-xl font-bold hover:bg-slate-600 active:bg-slate-500">{n}</button>
                                                        ))}
                                                        <button onClick={handleTenkeyDelete} className="bg-slate-700 p-3 rounded flex items-center justify-center hover:bg-slate-600"><Delete className="w-6 h-6"/></button>
                                                        <button onClick={()=>handleTenkeyInput(0)} className="bg-slate-700 p-3 rounded text-xl font-bold hover:bg-slate-600">0</button>
                                                        <button onClick={()=>handleTenkeyInput('.')} className="bg-slate-700 p-3 rounded text-xl font-bold hover:bg-slate-600">.</button>
                                                    </div>
                                                    <button onClick={handleTenkeyEnter} className="bg-green-600 text-white p-3 rounded font-bold hover:bg-green-500 active:bg-green-400 w-full mt-2">確定</button>
                                                </div>
                                            )}
                                        </div>
                                    )}
                                    <button onClick={()=>setManualMode(!manualMode)} className="text-xs text-slate-500 mt-4 underline">{manualMode?"音声に戻る":"手動入力"}</button>
                                </div>

                                {/* History */}
                                <div className="bg-slate-800 rounded border border-slate-700 h-64 flex flex-col">
                                    <div className="p-2 border-b border-slate-700 flex justify-between items-center">
                                        <span className="text-xs font-bold text-slate-400 flex gap-1"><History className="w-3 h-3"/>履歴</span>
                                        <button onClick={clearAllData} className="text-[10px] text-red-400 border border-red-900 px-2 py-0.5 rounded">全消去</button>
                                    </div>
                                    <div className="flex-1 overflow-y-auto p-2 space-y-2 custom-scrollbar">
                                        {currentContextItems.slice().reverse().map(i=>(
                                            <div key={i.id} className="bg-slate-900 p-2 rounded border-l-2 border-blue-500 flex justify-between items-center">
                                                <div className="flex items-center gap-2">
                                                    <span className="text-slate-500 text-xs w-6">No.{i.seq}</span>
                                                    <div>
                                                        <div className="text-base font-bold text-white font-mono">{i.code}</div>
                                                        <div className="text-xs text-slate-400">{i.inputQty}{i.isPile?'山':'個'} <span className="text-slate-600">→ {i.total}</span></div>
                                                    </div>
                                                </div>
                                                {/* ゴミ箱ボタンを大きく */}
                                                <button onClick={()=>removeItem(i.id)} className="text-slate-400 p-3 hover:text-red-400 hover:bg-slate-800 rounded"><Trash2 className="w-5 h-5"/></button>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            </>
                        )}

                        {activeTab === 'settings' && (
                            <div className="space-y-4">
                                <div className="bg-slate-800 p-4 rounded border border-slate-700">
                                    <h2 className="text-sm font-bold text-green-400 mb-2 flex gap-1"><MapPin className="w-4 h-4"/>エリア設定</h2>
                                    <label className="block w-full bg-slate-700 text-center p-2 rounded cursor-pointer text-xs text-slate-300 hover:bg-slate-600 mb-2">
                                        <Cloud className="w-4 h-4 inline mr-1"/>CSV読込 (Android対応)
                                        <input type="file" onChange={handleAreaUpload} className="hidden"/>
                                    </label>
                                    <div className="bg-slate-900 p-2 rounded h-24 overflow-y-auto text-xs text-slate-500">{areaList.map(n=><div key={n}>{n}</div>)}</div>
                                </div>
                                <div className="bg-slate-800 p-4 rounded border border-slate-700">
                                    <h2 className="text-sm font-bold text-blue-400 mb-2 flex gap-1"><Database className="w-4 h-4"/>容器設定</h2>
                                    <label className="block w-full bg-slate-700 text-center p-2 rounded cursor-pointer text-xs text-slate-300 hover:bg-slate-600">
                                        <Cloud className="w-4 h-4 inline mr-1"/>CSV読込 (Android対応)
                                        <input type="file" onChange={handleMasterUpload} className="hidden"/>
                                    </label>
                                </div>
                            </div>
                        )}
                    </div>
                </div>
            );
        }
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>